<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Londrina+Solid:wght@100;300;400;900&display=swap');
  </style>
  <meta charset="UTF-8" />
  <title>Byte2Bite | Recipes</title>
  <style>
    body {
      background-color: #fdfaf7;
      padding: 24px;
      color: #2a1d0f;
      transition: background-color 0.3s ease;
      font-size: 1.35em;
      min-height: 100vh;
      box-sizing: border-box;
      font-family: "Fredoka", sans-serif;
      font-optical-sizing: auto;
      font-weight: 700;
      font-style: normal;
      font-variation-settings: "wdth" 100;
    }

    h1 {
      position: static;
      margin: 36px 0 44px 0;
      text-align: center;
      font-size: 2.3em;
      font-family: "Londrina Solid", sans-serif;
      font-weight: 900;
      font-style: normal;
      transition: color 0.3s ease;
    }

    button {
      width: 92vw;
      max-width: 370px;
      height: 62px;
      margin: 18px auto;
      display: block;
      border: none;
      border-radius: 13px;
      background-color: #eddccb;
      font-size: 1.18em;
      font-family: "Fredoka", sans-serif;
      font-optical-sizing: auto;
      font-weight: 700;
      font-style: normal;
      font-variation-settings: "wdth" 100;
      color: #2a1d0f;
      transition: background-color color 0.3s ease;
      box-shadow: 0 2px 8px #0001;
    }

    button:active {
      background-color: #a18d78;
    }

    #chat-container {
      top: 100%;
      position: absolute;
      max-width: 600px;
      margin: auto;
      display: flex;
      gap: 10px;
      transition: background-color 0.3s ease;
    }

    input[type="text"] {
      right: 5%;
      top: 15%;
      position: absolute;
      flex: 1;
      padding: 10px;
      font-size: 100%;
      transition: background-color color 0.3s ease;
    }

    .searchRecipeBtn {
      right: 5%;
      position: absolute;
    }

    .themeToggle {
      width: 64px;
      height: 64px;
      border-radius: 20px;
      font-size: 2.5em;
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 1000;
      transition: background-color 0.3s ease;
    }

    .aiRecipeSuggestions {
      font-size: 1.13em !important;
      min-height: 48px;
      padding: 12px 12px !important;
    }
    .search-row input[type="text"] {
      font-size: 1.13em;
      padding: 12px;
      border-radius: 8px;
    }
    .search-row .searchRecipeBtn {
      font-size: 1.13em;
      padding: 12px 16px;
      border-radius: 8px;
    }
    .tab-header {
      gap: 18px;
      margin-bottom: 30px;
    }
    .tab-btn {
      font-size: 1.45em;
      padding: 0 16px;
      border-radius: 12px 12px 0 0;
    }
    .tab-btn.active {
      box-shadow: 0 2px 8px #eddccb;
    }
    .recipe-card, .ingredient-card {
      font-size: 1.05em;
      padding: 14px 0 0 0;
      min-height: 180px;
    }
    .card-content {
      font-size: 1.05em;
      padding: 0 0 10px 0;
    }
    .recipe-title {
      font-size: 1.18em;
    }
    .recipe-time {
      font-size: 1.05em;
    }
    .loader {
      width: 34px;
      height: 34px;
      border-width: 5px;
    }
    #recipeGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
      max-width: 1100px;
      margin: auto;
      padding: 10px;
      margin-top: 0;
      margin-bottom: 32px;
    }

    @media (max-width: 600px) {
      #recipeGrid {
        grid-template-columns: 1fr;
        padding: 0;
        margin-top: 24vw;
        margin-bottom: 24vw;
      }
    }

    .recipe-card {
      border: 2px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 2px 8px #0001;
      padding: 14px 0 0 0;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 260px;
    }
    .recipe-card img {
      width: 90%;
      height: 140px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .card-content {
      width: 90%;
      padding: 0 0 12px 0;
      text-align: center;
      margin-bottom: 8px;
    }
    .recipe-title {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 6px;
      font-family: "Fredoka", sans-serif;
      transition: color 0.3s;
    }
    .recipe-time {
      font-size: 0.95em;
      color: #666;
      margin-bottom: 4px;
    }

    @media (max-width: 600px) {
      #recipeGrid {
        grid-template-columns: 1fr;
        padding: 0;
      }
      .recipe-card {
        min-height: 200px;
        padding: 10px 0 0 0;
      }
      .card-content {
        padding: 0 0 10px 0;
      }
    }

    #modal {
      display: none;
      position: fixed;
      z-index: 99;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }

    #modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 80%;
      max-width: 700px;
      border-radius: 8px;
      white-space: pre-wrap;
    }

    .close {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    #loadingScreen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s;
    }
    #loadingScreen > div {
      background: #fff;
      color: #222;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0003;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: background-color 0.3s, color 0.3s;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loader {
      width: 48px;
      height: 48px;
      border: 6px solid #00c0f5;
      border-top: 6px solid #eee;
      border-radius: 50%;
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    button.recipe, button.pantry, button#Recipes, button#findWithPantry {
      width: 90vw;
      max-width: 400px;
      height: 70px;
      margin: 16px auto;
      display: block;
      border: none;
      border-radius: 12px;
      background-color: #eddccb;
      font-size: 1.2em;
      font-family: "Fredoka", sans-serif;
      font-optical-sizing: auto;
      font-weight: 700;
      font-style: normal;
      font-variation-settings: "wdth" 100;
      color: #2a1d0f;
      transition: background-color color 0.3s ease;
      box-shadow: 0 2px 8px #0001;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: break-word;
      padding: 0 12px;
    }
    .aiRecipeSuggestions, .searchRecipeBtn {
      position: static !important;
      left: unset !important;
      right: unset !important;
      top: unset !important;
      width: 90vw;
      max-width: 400px;
      margin: 8px auto;
      display: block;
    }
    input[type="text"] {
      position: static !important;
      right: unset !important;
      top: unset !important;
      width: 70%;
      max-width: 320px;
      margin: 8px auto 0 auto;
      display: block;
    }
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
      z-index: 20;
      background: inherit;
    }
    @media (max-width: 600px) {
      .action-buttons {
        position: sticky;
        top: 0;
        background: #fdfaf7;
        z-index: 20;
        padding-top: 8px;
        padding-bottom: 8px;
      }
      body.dark-mode .action-buttons {
        background: #181818;
      }
    }
    #recipeGrid {
      margin-top: 0;
      margin-bottom: 32px;
      z-index: 1;
    }

    .search-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      margin: 0 0 8px 0;
    }
    .search-row input[type="text"] {
      width: 60%;
      min-width: 120px;
      max-width: 220px;
      margin: 0;
      font-size: 1em;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #aaa;
      box-sizing: border-box;
      display: inline-block;
    }
    .search-row .searchRecipeBtn {
      width: auto;
      min-width: 120px;
      max-width: 180px;
      padding: 10px 16px;
      font-size: 1em;
      margin: 0;
      display: inline-block;
    }
    @media (max-width: 600px) {
      .search-row {
        flex-direction: column;
        gap: 6px;
        align-items: stretch;
      }
      .search-row input[type="text"],
      .search-row .searchRecipeBtn {
        width: 100%;
        max-width: 100%;
        min-width: 0;
      }
    }

    .tab-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 48px;
    }
    .tab-btn {
      font-family: "Londrina Solid", sans-serif;
      font-size: 3em;
      font-weight: 900;
      background: none;
      border: none;
      color: #2a1d0f;
      padding: 0 32px;
      cursor: pointer;
      border-bottom: 4px solid transparent;
      transition: color 0.2s, border-color 0.2s;
      outline: none;
    }
    .tab-btn.active {
      color: #a18d78;
      background: linear-gradient(90deg, #ffe6b3 80%, #fff7d6 100%);
      border-bottom: 4px solid #a18d78;
      box-shadow: 0 2px 8px #eddccb;
      border-radius: 12px 12px 0 0;
      z-index: 2;
      position: relative;
    }

    button, .tab-btn, .aiRecipeSuggestions, .searchRecipeBtn, .pantry {
      white-space: normal !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
      text-overflow: ellipsis;
      line-height: 1.15;
    }
    .tab-btn {
      max-width: 40vw;
      min-width: 0;
      overflow: hidden;
      text-align: center;
      padding-left: 0;
      padding-right: 0;
    }
    .aiRecipeSuggestions, .searchRecipeBtn, .pantry {
      max-width: 100%;
      min-width: 0;
    }
    button, .searchRecipeBtn, .pantry {
      padding-left: 12px;
      padding-right: 12px;
    }
    .search-row input[type="text"] {
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
    }
    .recipe-title, .card-content, .recipe-time {
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      text-align: center;
    }

    /* Dark mode styles */
    body.dark-mode {
      background-color: #181818;
      color: #f5f5f5;
    }
    body.dark-mode button {
      background-color: #333 !important;
      color: #f5f5f5 !important;
      border-color: #555 !important;
    }
    body.dark-mode h1 {
      color: #f5f5f5;
    }
    body.dark-mode .recipe-card {
      background-color: #232323;
      border-color: #444;
      color: #f5f5f5;
    }
    body.dark-mode .card-content {
      color: #f5f5f5;
    }
    body.dark-mode button, body.dark-mode .pantry {
      background-color: #333 !important;
      color: #f5f5f5 !important;
      border-color: #555 !important;
    }
    body.dark-mode input[type="text"] {
      background-color: #232323;
      color: #f5f5f5;
      border: 1px solid #555;
    }
    body.dark-mode #modal-content {
      background-color: #232323;
      color: #f5f5f5;
    }
    body.dark-mode .ingredient-card {
      background-color: #232323 !important;
      color: #f5f5f5 !important;
      border-color: #555 !important;
    }
    body.dark-mode #loadingScreen {
      background: rgba(0,0,0,0.7);
    }
    body.dark-mode #loadingScreen > div {
      background: #232323;
      color: #f5f5f5;
    }
    body.dark-mode .loader {
      border: 4px solid #00c0f5;
      border-top: 4px solid #444;
    }
    body.dark-mode .tab-btn {
      color: #f5f5f5;
    }
    body.dark-mode .tab-btn.active {
      color: #ffe6b3;
      background: linear-gradient(90deg, #3a2c1a 60%, #232323 100%);
      border-bottom: 4px solid #a18d78;
      box-shadow: 0 2px 8px #000a;
      border-radius: 12px 12px 0 0;
      z-index: 2;
      position: relative;
    }

  </style>

</head>
<body>
    <div class="tab-header fade-in">
      <button class="tab-btn" id="pantryTab">Pantry</button>
      <button class="tab-btn active" id="recipesTab">Recipes</button>
    </div>
    <button id="themeToggle" style="position: absolute; top: 20px; right: 20px; z-index: 1000;" class="themeToggle fade-in">ðŸŒ™</button>
    <div class="action-buttons fade-in">
      <button id="aiRecipeSuggestions" class="aiRecipeSuggestions">Find recipes with pantry items</button>
      <div class="search-row">
        <input type="text" id="searchRecipeInput" placeholder="Search for recipes..." />
        <button id="searchRecipeBtn" class="searchRecipeBtn">Search Any Recipe</button>
      </div>
      <div id="searchResult"></div>
    </div>
    <div id="recipeGrid" class="fade-in"></div>
    <div id="modal">
      <div id="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-text"></div>
      </div>
    </div>
    <div id="loadingScreen">
      <div>
        <span class="loader"></span>
        Loading recipe(s)...
      </div>
    </div>

  <script>
    const OPENAI_KEY = "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";
    const PEXELS_KEY = "0DRl8iBX2qxNjYeNOPbqoEwOoaqYqPypoynF2KHNN5JXU0HJX1nQE2r1";


    async function sendMessage() {
      const input = document.getElementById("userInput");
      const userMessage = input.value.trim();
      if (!userMessage) return;
      input.value = "";

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + OPENAI_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-4.1-mini",
          messages: [
            { role: "system", content: "You're a helpful cooking assistant who replies with delicious, simple recipes that include a cook time." },
            { role: "user", content: userMessage }
          ]
        })
      });

      const data = await response.json();
      const aiReply = data.choices?.[0]?.message?.content || "Error fetching recipe.";
      addRecipeToGrid(aiReply);
    }

    async function fetchFoodImage(title) {
      const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(title)}&per_page=1`, {
        headers: { Authorization: PEXELS_KEY }
      });
      const data = await response.json();
      return data.photos?.[0]?.src?.medium || "https://via.placeholder.com/300x140?text=No+Image";
    }

    async function addRecipeToGrid(recipeText) {
      const grid = document.getElementById("recipeGrid");

      const titleMatch = recipeText.match(/^#+\s*(.+)/m);
      const title = titleMatch ? titleMatch[1].trim() : "Suggested Recipe";

      const timeMatch = recipeText.match(/(\d+[\s-]?(minutes|min|mins|hours|hrs))/i);
      const prepTime = timeMatch ? timeMatch[0] : "Time unknown";

      // Try to extract ingredients from the recipeText
      let missingIngredients = [];
      const pantry = getPantry();
      const ingredientsSection = recipeText.match(/ingredients:?\s*([\s\S]*?)(?:\n\s*instructions:|\n\s*steps:|\n#|$)/i);
      if (ingredientsSection) {
        const lines = ingredientsSection[1].split(/\n|\r/).map(l => l.trim()).filter(Boolean);
        for (const line of lines) {
          let ing = line.replace(/^[-*]\s*/, '').replace(/:.*/, '').replace(/\d+.*/, '').trim();
          if (!ing) continue;
          const lowerIng = ing.toLowerCase();
          // Ignore lines that are just '*' or '-' or have no letters
          if (!/[a-z]/i.test(ing)) continue;
          // Ignore lines that contain section headers or non-ingredient cues
          if (
            lowerIng.includes('optional') ||
            lowerIng.includes('instruction') ||
            lowerIng.includes('step') ||
            lowerIng.includes('direction') ||
            lowerIng.includes('method') ||
            lowerIng.includes('preparation') ||
            lowerIng.includes('note') ||
            lowerIng.includes('tip') ||
            lowerIng.includes('yield') ||
            lowerIng.includes('garnish') ||
            lowerIng.includes('suggestion')
          ) continue;
          // Ignore lines that are likely not ingredients (long sentences, tips, etc.)
          if (ing.length > 60) continue;
          if (/(!|\?)$/.test(ing)) continue;
          let found = false;
          for (const key in pantry) {
            const pantryName = key.toLowerCase().replace(/[^a-z]/g, '');
            const ingName = ing.toLowerCase().replace(/[^a-z]/g, '');
            // Special case: 'pepper' matches 'black pepper' or 'white pepper'
            if (
              ((ingName === 'pepper' && (pantryName.includes('blackpepper') || pantryName.includes('whitepepper'))) ||
               (pantryName === 'pepper' && (ingName.includes('blackpepper') || ingName.includes('whitepepper')))) &&
              pantry[key] > 0
            ) {
              found = true;
              break;
            }
            // General partial match
            if (
              (pantryName.includes(ingName) || ingName.includes(pantryName)) &&
              pantryName.length >= 3 && ingName.length >= 3 &&
              pantry[key] > 0
            ) {
              found = true;
              break;
            }
          }
          if (!found) missingIngredients.push(ing);
        }
      }

      const imageUrl = await fetchFoodImage(title);

      const card = document.createElement("div");
      card.className = "recipe-card";
      card.onclick = () => openModal(recipeText + (missingIngredients.length ? `\n\nMissing ingredients: ${missingIngredients.join(', ')}` : ''));

      const image = document.createElement("img");
      image.src = imageUrl;
      image.alt = title;

      const content = document.createElement("div");
      content.className = "card-content";

      const titleEl = document.createElement("div");
      titleEl.className = "recipe-title";
      titleEl.textContent = title;

      const timeEl = document.createElement("div");
      timeEl.className = "recipe-time";
      timeEl.textContent = "â±ï¸ " + prepTime;

      content.appendChild(titleEl);
      content.appendChild(timeEl);
      if (missingIngredients.length) {
        const missingEl = document.createElement("div");
        missingEl.style.color = "#c00";
        missingEl.style.fontSize = "14px";
        missingEl.textContent = "Missing: " + missingIngredients.join(', ');
        content.appendChild(missingEl);
      }
      card.appendChild(image);
      card.appendChild(content);
      grid.appendChild(card);
    }

    function openModal(text) {
      document.getElementById("modal-text").textContent = text;
      document.getElementById("modal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    window.onclick = function(event) {
      if (event.target === document.getElementById("modal")) {
        closeModal();
      }
    };

    function showLoading() {
      document.getElementById('loadingScreen').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingScreen').style.display = 'none';
    }

    document.getElementById('searchRecipeBtn').onclick = async function() {
  const name = document.getElementById('searchRecipeInput').value.trim().toLowerCase();
  const resultDiv = document.getElementById('searchResult');
  if (!name) {
    resultDiv.textContent = 'Please enter a recipe name.';
    return;
  }
  showLoading();
  try {
    const prompt = `Give me a recipe for ${name}. Include a title, cook time, ingredient list, and step-by-step instructions.`;
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + OPENAI_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "gpt-4.1-mini",
        messages: [
          { role: "system", content: "You're a helpful cooking assistant who replies with delicious, simple recipes that include a cook time." },
          { role: "user", content: prompt }
        ]
      })
    });
    const data = await response.json();
    const aiReply = data.choices?.[0]?.message?.content || "Error fetching recipe.";
    await addRecipeToGrid(aiReply);
    resultDiv.textContent = '';
  } finally {
    hideLoading();
  }
};

    document.getElementById('aiRecipeSuggestions').onclick = async function() {
      const pantry = getPantry();
      const ingredientList = Object.entries(pantry)
        .filter(([_, qty]) => qty > 0)
        .map(([name, qty]) => `${name} (${qty})`).join(', ');
      if (!ingredientList) {
        alert('Your pantry is empty!');
        return;
      }
      showLoading();
      try {
        const prompt = `What recipes can I make with these ingredients: ${ingredientList}? For each recipe, include a title, cook time, ingredient list, and step-by-step instructions. Format each recipe starting with a line like '# Recipe Name'.`;
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + OPENAI_KEY,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "gpt-4.1-mini",
            messages: [
              { role: "system", content: "You're a helpful cooking assistant who replies with delicious, simple recipes that include a cook time." },
              { role: "user", content: prompt }
            ]
          })
        });
        const data = await response.json();
        const aiReply = data.choices?.[0]?.message?.content || "Error fetching recipes.";
        // Split AI reply into individual recipes if possible
        const recipesArr = aiReply.split(/\n(?=# )/g); // Split on lines starting with #
        const grid = document.getElementById('recipeGrid');
        // Do NOT clear grid, just add new recipes
        for (let recipeText of recipesArr) {
          recipeText = recipeText.replace(/^\d+\.\s*/, ''); // Remove leading number and dot if present
          await addRecipeToGrid(recipeText.trim());
        }
      } finally {
        hideLoading();
      }
    };

    function getPantry() {
  const pantry = {};
  for (const key in localStorage) {
    if (key.startsWith('ingredient-')) {
      const name = key.replace('ingredient-', '');
      pantry[name] = parseFloat(localStorage.getItem(key)) || 0;
    }
  }
  return pantry;
}

    // Theme toggle logic
    const themeToggle = document.getElementById('themeToggle');
    function setTheme(mode) {
      if (mode === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggle.textContent = 'â˜€ï¸';
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        themeToggle.textContent = 'ðŸŒ™';
        localStorage.setItem('theme', 'light');
      }
    }
    themeToggle.onclick = function() {
      setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
    };
    // On load, set theme from localStorage
    setTheme(localStorage.getItem('theme') === 'dark' ? 'dark' : 'light');

    // Ensure fade-in animation always triggers on page load (shorter duration)
window.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.fade-in').forEach(function(el) {
    el.classList.remove('fade-in');
  });
  void document.body.offsetWidth;
  document.querySelectorAll('.tab-header, .themeToggle, h1, .action-buttons, #recipeGrid').forEach(function(el) {
    el.classList.add('fade-in');
  });
});

    // Tab navigation logic
const pantryTab = document.getElementById('pantryTab');
const recipesTab = document.getElementById('recipesTab');
if (pantryTab && recipesTab) {
  recipesTab.onclick = (e) => { e.preventDefault(); };
  pantryTab.onclick = (e) => {
    e.preventDefault();
    document.querySelectorAll('.fade-in').forEach(el => {
      el.classList.remove('fade-in');
      el.classList.add('fade-out');
      el.style.opacity = 0;
    });
    setTimeout(() => {
      window.location.href = 'pantry.html';
    }, 400);
  };
}
  </script>
</body>
</html>
